#!/usr/bin/env ruby
# frozen_string_literal: true

# usage: bin/release VERSION

require 'bundler/setup'
require 'rubocop_challenger'

VERSION_FORMAT = /\A\d+\.\d+\.\d+(\.(pre|beta|rc)\d?)?\z/.freeze
version = ARGV[0]
rubocop = RubocopChallenger::Rubocop::Command.new
pr_comet = PrComet.new(base: 'master', branch: "update/v#{version}")

# Verifying
abort 'usage: bin/release VERSION' if version.nil?
abort 'A version must be like a `1.2.3`' unless version =~ VERSION_FORMAT

# Modify a version file
pr_comet.commit 'Update version' do
  File.write('lib/rubocop_challenger/version.rb', <<~VERSION)
    # frozen_string_literal: true

    module RubocopChallenger
      VERSION = '#{version}'
    end
  VERSION
end

# Bundle Update
pr_comet.commit 'Run $ bundle update' do
  `bundle update`
end

# Regenerate .rubocop_todo.yml
pr_comet.commit 'Regenerate .rubocop_todo.yml' do
  rubocop.auto_gen_config
end

# Create a pull request
pr_comet.create!(title: "Update v#{version}", body: '')
