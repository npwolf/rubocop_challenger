#!/usr/bin/env ruby
# frozen_string_literal: true

# usage: bin/create_release_pr VERSION

require 'bundler/setup'
require 'rubocop_challenger'

def exit_process(error_message)
  puts error_message
  exit!
end

VERSION_FORMAT = /\A\d+\.\d+\.\d+\z/.freeze
version = ARGV[0]
rubocop = RubocopChallenger::Rubocop::Command.new
pr_creater =
  RubocopChallenger::Github::PrCreater.new(
    access_token: ENV['GITHUB_ACCESS_TOKEN'],
    branch: "update/v#{version}"
  )

# Verifying
exit_process 'usage: bin/create_release_pr VERSION' if version.nil?
exit_process 'A version must be like a `1.2.3`' unless version =~ VERSION_FORMAT

# Modify a version file
pr_creater.commit 'Update version' do
  File.write('lib/rubocop_challenger/version.rb', <<~VERSION)
    # frozen_string_literal: true

    module RubocopChallenger
      VERSION = '#{version}'
    end
  VERSION
end

# Bundle Update
pr_creater.commit 'Run $ bundle update' do
  `bundle update`
end

# Regenerate .rubocop_todo.yml
pr_creater.commit 'Regenerate .rubocop_todo.yml' do
  rubocop.auto_gen_config
end

# Create PR
pr_creater.create_pr(title: "Update v#{version}", body: '', base: 'master')
